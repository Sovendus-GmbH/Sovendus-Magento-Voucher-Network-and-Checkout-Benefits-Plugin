{"version":3,"file":"sovendus-page.js","sources":["../../../../sovendus-plugins-commons/page-scripts/constants.ts","../../../../sovendus-plugins-commons/page-scripts/utils.ts","../../../../sovendus-plugins-commons/page-scripts/landing-page/sovendus-page.ts"],"sourcesContent":["export const sovReqTokenKey = \"sovReqToken\";\nexport const sovReqProductIdKey = \"sovReqProductId\";\nexport const optimizeDomain = \"https://www.sovopt.com/\";\n","import { sovReqProductIdKey, sovReqTokenKey } from \"../page-scripts/constants\";\nimport type { OptimizeSettings } from \"../settings/app-settings\";\nimport type { CountryCodes } from \"../settings/sovendus-countries\";\n\nexport async function handleCheckoutProductsConversion(\n  checkoutProducts: boolean,\n  getCookie: (\n    name: string,\n  ) => Promise<string | undefined> | (string | undefined),\n  setCookie: (\n    name: string,\n    value?: string | undefined,\n  ) => Promise<string> | string,\n): Promise<boolean> {\n  if (checkoutProducts) {\n    const sovReqToken = await getCookie(sovReqTokenKey);\n    const sovReqProductId = await getCookie(sovReqProductIdKey);\n    if (sovReqToken && sovReqProductId) {\n      // remove the cookies\n      await setCookie(sovReqTokenKey, \"\");\n      await setCookie(sovReqProductIdKey, \"\");\n      const pixelUrl = `https://press-order-api.sovendus.com/ext/${decodeURIComponent(\n        sovReqProductId,\n      )}/image?sovReqToken=${decodeURIComponent(sovReqToken)}`;\n      await fetch(pixelUrl);\n      return true;\n    }\n  }\n  return false;\n}\n\nexport async function handleCheckoutProductsPage(\n  checkoutProductsEnabled: boolean | undefined,\n  pageHref: string,\n  setCookie: (cookieOrName: string, value?: string) => Promise<string>,\n): Promise<boolean> {\n  if (checkoutProductsEnabled) {\n    const sovReqToken = getParamFromUrl(pageHref, sovReqTokenKey);\n    if (sovReqToken) {\n      const sovReqProductId = getParamFromUrl(pageHref, sovReqProductIdKey);\n      await setCookie(sovReqTokenKey, sovReqToken);\n      if (sovReqProductId) {\n        await setCookie(sovReqProductIdKey, sovReqProductId);\n        return true;\n      }\n    }\n  }\n  return false;\n}\n\nfunction getParamFromUrl(pageHref: string, key: string): string | undefined {\n  const url = new URL(pageHref);\n  return url.searchParams.get(key) || undefined;\n}\n\nexport function getOptimizeConfig(\n  settings: OptimizeSettings,\n  country: CountryCodes | undefined,\n): string | undefined {\n  if (\n    settings.globalEnabled !== false &&\n    settings.useGlobalId !== false &&\n    settings.globalId\n  ) {\n    return settings.globalId;\n  }\n  if (country && settings.countrySpecificIds) {\n    const countryElement = settings.countrySpecificIds[country];\n    return countryElement?.isEnabled ? countryElement?.optimizeId : undefined;\n  }\n  return undefined;\n}\n","import type { SovendusAppSettings } from \"../../settings/app-settings\";\nimport type { CountryCodes } from \"../../settings/sovendus-countries\";\nimport { getOptimizeConfig, handleCheckoutProductsPage } from \"../utils\";\n\ninterface SovendusPageConfig {\n  settings: SovendusAppSettings;\n  integrationType: string;\n  country: CountryCodes | undefined;\n}\n\ninterface SovPageWindow extends Window {\n  sovPageConfig: SovendusPageConfig;\n  sovPageStatus: {\n    loadedOptimize?: boolean;\n    loadedVoucherNetworkSwitzerland?: boolean;\n    executedCheckoutProducts?: boolean;\n    sovPageConfigFound?: boolean;\n  };\n}\n\ndeclare let window: SovPageWindow;\n\nasync function main(): Promise<void> {\n  const pageSettings = window.sovPageConfig;\n  window.sovPageStatus = {};\n  if (typeof pageSettings !== \"undefined\") {\n    window.sovPageStatus.sovPageConfigFound = true;\n    const {\n      optimizeId,\n      checkoutProductsEnabled,\n      voucherNetworkSwitzerlandEnabled,\n    } = getSovendusConfig(pageSettings.settings, pageSettings.country);\n    handleOptimizePageScript(optimizeId);\n    handleVoucherNetworkSwitzerland(voucherNetworkSwitzerlandEnabled);\n    window.sovPageStatus.executedCheckoutProducts =\n      await handleCheckoutProductsPage(\n        checkoutProductsEnabled,\n        window.location.href,\n        setCookie,\n      );\n  } else {\n    window.sovPageStatus.sovPageConfigFound = false;\n    // eslint-disable-next-line no-console\n    console.error(\"sovPageConfig is not defined\");\n  }\n}\n\ninterface ParsedPageConfig {\n  optimizeId: string | undefined;\n  checkoutProductsEnabled: boolean;\n  voucherNetworkSwitzerlandEnabled: boolean | undefined;\n}\n\nfunction getSovendusConfig(\n  settings: SovendusAppSettings,\n  country: CountryCodes | undefined,\n): ParsedPageConfig {\n  const countryCode: CountryCodes | undefined = country || detectCountryCode();\n  const vnSwitzerland = settings.voucherNetwork.countries.CH?.languages;\n  return {\n    optimizeId: getOptimizeConfig(settings.optimize, countryCode),\n    checkoutProductsEnabled: settings.checkoutProducts,\n    voucherNetworkSwitzerlandEnabled:\n      vnSwitzerland?.DE?.isEnabled ||\n      vnSwitzerland?.IT?.isEnabled ||\n      vnSwitzerland?.FR?.isEnabled,\n  };\n}\n\n// eslint-disable-next-line @typescript-eslint/require-await\nasync function setCookie(cookieName: string, value?: string): Promise<string> {\n  const path: string = \"/\";\n  const expires: number = 60 * 60 * 24 * 30;\n  const domain = window.location.hostname;\n  const cookieString = `${cookieName}=${value};secure;samesite=strict;max-age=${expires};domain=${domain};path=${path}`;\n  document.cookie = cookieString;\n  return value || \"\";\n}\n\nfunction handleVoucherNetworkSwitzerland(\n  voucherNetworkSwitzerlandEnabled: boolean | undefined,\n): void {\n  if (voucherNetworkSwitzerlandEnabled) {\n    const script = document.createElement(\"script\");\n    script.type = \"text/javascript\";\n    script.async = true;\n    script.src = \"https://api.sovendus.com/js/landing.js\";\n    document.body.appendChild(script);\n    window.sovPageStatus.loadedVoucherNetworkSwitzerland = true;\n  }\n}\n\nfunction detectCountryCode(): CountryCodes | undefined {\n  const getCountryCodeFromHtmlTag = (): CountryCodes | undefined => {\n    const lang = document.documentElement.lang;\n    const countryCode = lang.split(\"-\")[1];\n    return countryCode\n      ? (countryCode.toUpperCase() as CountryCodes)\n      : undefined;\n  };\n  const getCountryFromDomain = (): CountryCodes | undefined => {\n    const domainToCountry: {\n      [key: string]: string | undefined;\n    } = {\n      \"de\": \"DE\",\n      \"at\": \"AT\",\n      \"ch\": \"CH\",\n      \"uk\": \"GB\",\n      \"co.uk\": \"GB\",\n      \"com\": undefined,\n      \"se\": \"SE\",\n      \"no\": \"NO\",\n      \"dk\": \"DK\",\n      \"fi\": \"FI\",\n      \"fr\": \"FR\",\n      \"be\": \"BE\",\n      \"nl\": \"NL\",\n      \"it\": \"IT\",\n      \"es\": \"ES\",\n      \"pt\": \"PT\",\n      \"pl\": \"PL\",\n      \"cz\": \"CZ\",\n      \"sk\": \"SK\",\n      \"hu\": \"HU\",\n    };\n    const domain = window.location.hostname;\n    const domainParts = domain.split(\".\");\n    const domainPart = domainParts[domainParts.length - 1];\n    return (domainPart ? domainToCountry[domainPart] : undefined) as\n      | CountryCodes\n      | undefined;\n  };\n  const getCountryFromPagePath = (): CountryCodes | undefined => {\n    const path = window.location.pathname;\n    const pathParts = path.split(\"/\");\n    const country = pathParts[1];\n    return country?.toUpperCase() as CountryCodes | undefined;\n  };\n  return (\n    getCountryCodeFromHtmlTag() ||\n    getCountryFromDomain() ||\n    getCountryFromPagePath()\n  );\n}\n\nfunction handleOptimizePageScript(optimizeId: string | undefined): void {\n  if (!optimizeId) {\n    return;\n  }\n  window.sovPageStatus.loadedOptimize = true;\n  const getbackDomain = \"https://www.sovopt.com/\";\n  const script = document.createElement(\"script\");\n  script.src = `${getbackDomain}${optimizeId}`;\n  script.type = \"application/javascript\";\n  document.body.appendChild(script);\n}\n\nvoid main();\n"],"names":["setCookie"],"mappings":"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"}