{"version":3,"file":"thankyou-page.js","sources":["../../../../sovendus-plugins-commons/page-scripts/constants.ts","../../../../sovendus-plugins-commons/page-scripts/utils.ts","../../../../sovendus-plugins-commons/page-scripts/thankyou-page/thankyou-page.ts"],"sourcesContent":["export const sovReqTokenKey = \"sovReqToken\";\nexport const sovReqProductIdKey = \"sovReqProductId\";\nexport const optimizeDomain = \"https://www.sovopt.com/\";\n","import { sovReqProductIdKey, sovReqTokenKey } from \"../page-scripts/constants\";\nimport type { OptimizeSettings } from \"../settings/app-settings\";\nimport type { CountryCodes } from \"../settings/sovendus-countries\";\n\nexport async function handleCheckoutProductsConversion(\n  checkoutProducts: boolean,\n  getCookie: (\n    name: string,\n  ) => Promise<string | undefined> | (string | undefined),\n  setCookie: (\n    name: string,\n    value?: string | undefined,\n  ) => Promise<string> | string,\n): Promise<boolean> {\n  if (checkoutProducts) {\n    const sovReqToken = await getCookie(sovReqTokenKey);\n    const sovReqProductId = await getCookie(sovReqProductIdKey);\n    if (sovReqToken && sovReqProductId) {\n      // remove the cookies\n      await setCookie(sovReqTokenKey, \"\");\n      await setCookie(sovReqProductIdKey, \"\");\n      const pixelUrl = `https://press-order-api.sovendus.com/ext/${decodeURIComponent(\n        sovReqProductId,\n      )}/image?sovReqToken=${decodeURIComponent(sovReqToken)}`;\n      await fetch(pixelUrl);\n      return true;\n    }\n  }\n  return false;\n}\n\nexport async function handleCheckoutProductsPage(\n  checkoutProductsEnabled: boolean | undefined,\n  pageHref: string,\n  setCookie: (cookieOrName: string, value?: string) => Promise<string>,\n): Promise<boolean> {\n  if (checkoutProductsEnabled) {\n    const sovReqToken = getParamFromUrl(pageHref, sovReqTokenKey);\n    if (sovReqToken) {\n      const sovReqProductId = getParamFromUrl(pageHref, sovReqProductIdKey);\n      await setCookie(sovReqTokenKey, sovReqToken);\n      if (sovReqProductId) {\n        await setCookie(sovReqProductIdKey, sovReqProductId);\n        return true;\n      }\n    }\n  }\n  return false;\n}\n\nfunction getParamFromUrl(pageHref: string, key: string): string | undefined {\n  const url = new URL(pageHref);\n  return url.searchParams.get(key) || undefined;\n}\n\nexport function getOptimizeConfig(\n  settings: OptimizeSettings,\n  country: CountryCodes | undefined,\n): string | undefined {\n  if (\n    settings.globalEnabled !== false &&\n    settings.useGlobalId !== false &&\n    settings.globalId\n  ) {\n    return settings.globalId;\n  }\n  if (country && settings.countrySpecificIds) {\n    const countryElement = settings.countrySpecificIds[country];\n    return countryElement?.isEnabled ? countryElement?.optimizeId : undefined;\n  }\n  return undefined;\n}\n","import type {\n  SovendusAppSettings,\n  VoucherNetworkLanguage,\n  VoucherNetworkSettings,\n} from \"../../settings/app-settings\";\nimport type {\n  CountryCodes,\n  LanguageCodes,\n} from \"../../settings/sovendus-countries\";\nimport { getOptimizeConfig, handleCheckoutProductsConversion } from \"../utils\";\n\nexport interface SovendusThankYouPageConfig {\n  settings: SovendusAppSettings;\n  sessionId: string | undefined;\n  timestamp: string | undefined;\n  orderId: string | undefined;\n  orderValue: string | undefined;\n  orderCurrency: string | undefined;\n  usedCouponCodes: string | undefined;\n  iframeContainerId: string;\n  integrationType: string;\n  consumerFirstName: string | undefined;\n  consumerLastName: string | undefined;\n  consumerEmail: string | undefined;\n  consumerStreet: string | undefined;\n  consumerStreetNumber: string | undefined;\n  consumerZipcode: string | undefined;\n  consumerCity: string | undefined;\n  consumerCountry: CountryCodes;\n  consumerLanguage: LanguageCodes | undefined;\n  consumerPhone: string | undefined;\n}\n\ninterface ThankYouWindow extends Window {\n  sovThankyouConfig: SovendusThankYouPageConfig;\n  sovIframes: {\n    trafficSourceNumber: string;\n    trafficMediumNumber: string;\n    sessionId: string | undefined;\n    timestamp: string | undefined;\n    orderId: string | undefined;\n    orderValue: string | undefined;\n    orderCurrency: string | undefined;\n    usedCouponCode: string | undefined;\n    iframeContainerId: string;\n    integrationType: string;\n  }[];\n  sovConsumer: {\n    consumerFirstName: string | undefined;\n    consumerLastName: string | undefined;\n    consumerEmail: string | undefined;\n    consumerStreet: string | undefined;\n    consumerStreetNumber: string | undefined;\n    consumerZipcode: string | undefined;\n    consumerCity: string | undefined;\n    consumerCountry: CountryCodes;\n    consumerPhone: string | undefined;\n  };\n  sovThankyouStatus: {\n    loadedOptimize?: boolean;\n    loadedVoucherNetwork?: boolean;\n    executedCheckoutProducts?: boolean;\n    sovThankyouConfigFound?: boolean;\n    countryCodePassedOnByPlugin?: boolean;\n  };\n}\n\ndeclare let window: ThankYouWindow;\n\nasync function sovendusThankYou(): Promise<void> {\n  const config = window.sovThankyouConfig;\n  window.sovThankyouStatus = {};\n  if (!config) {\n    window.sovThankyouStatus.sovThankyouConfigFound = false;\n    // eslint-disable-next-line no-console\n    console.error(\"sovThankyouConfig is not defined\");\n    return;\n  }\n  window.sovThankyouStatus.sovThankyouConfigFound = true;\n  const { optimizeId, checkoutProducts, voucherNetwork } = getSovendusConfig(\n    config.settings,\n    config.consumerCountry,\n    config.consumerLanguage,\n  );\n  handleVoucherNetwork(voucherNetwork, config);\n  window.sovThankyouStatus.executedCheckoutProducts =\n    await handleCheckoutProductsConversion(\n      checkoutProducts,\n      getCookie,\n      setCookie,\n    );\n  handleOptimizeConversion(optimizeId, config);\n}\n\nfunction handleOptimizeConversion(\n  optimizeId: string | undefined,\n  config: SovendusThankYouPageConfig,\n): void {\n  if (optimizeId) {\n    const script = document.createElement(\"script\");\n    script.type = \"text/javascript\";\n    script.async = true;\n    script.src = `https://www.sovopt.com/${optimizeId}/conversion/?ordervalue=${\n      config.orderValue\n    }&ordernumber=${config.orderId}&vouchercode=${\n      config.usedCouponCodes?.[0]\n    }&email=${config.consumerEmail}`;\n    window.sovThankyouStatus.loadedOptimize = true;\n  }\n}\n\nfunction handleVoucherNetwork(\n  voucherNetworkConfig: VoucherNetworkLanguage | undefined,\n  config: SovendusThankYouPageConfig,\n): void {\n  if (\n    voucherNetworkConfig?.trafficSourceNumber &&\n    voucherNetworkConfig.trafficMediumNumber\n  ) {\n    window.sovIframes = window.sovIframes || [];\n    window.sovIframes.push({\n      trafficSourceNumber: voucherNetworkConfig.trafficSourceNumber,\n      trafficMediumNumber: voucherNetworkConfig.trafficMediumNumber,\n      sessionId: config.sessionId,\n      timestamp: config.timestamp,\n      orderId: config.orderId,\n      orderValue: config.orderValue,\n      orderCurrency: config.orderCurrency,\n      usedCouponCode: config.usedCouponCodes?.[0],\n      iframeContainerId: config.iframeContainerId,\n      integrationType: config.integrationType,\n    });\n    window.sovConsumer = {\n      consumerFirstName: config.consumerFirstName,\n      consumerLastName: config.consumerLastName,\n      consumerEmail: config.consumerEmail,\n      consumerStreet: config.consumerStreet,\n      consumerStreetNumber: config.consumerStreetNumber,\n      consumerZipcode: config.consumerZipcode,\n      consumerCity: config.consumerCity,\n      consumerCountry: config.consumerCountry,\n      consumerPhone: config.consumerPhone,\n    };\n    const script = document.createElement(\"script\");\n    script.type = \"text/javascript\";\n    script.async = true;\n    script.src = `${\n      window.location.protocol\n    }//api.sovendus.com/sovabo/common/js/flexibleIframe.js`;\n    document.body.appendChild(script);\n    window.sovThankyouStatus.loadedVoucherNetwork = true;\n  }\n}\n\nconst getCookie = (name: string): string | undefined => {\n  const value = `; ${document.cookie}`;\n  const parts = value.split(`; ${name}=`);\n  if (parts.length === 2) {\n    return parts.pop()?.split(\";\").shift();\n  }\n  return undefined;\n};\n\nconst setCookie = (name: string): string => {\n  document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;\n  return \"\";\n};\n\ninterface ParsedThankYouPageConfig {\n  optimizeId: string | undefined;\n  voucherNetwork: VoucherNetworkLanguage | undefined;\n  checkoutProducts: boolean;\n}\n\nfunction getSovendusConfig(\n  settings: SovendusAppSettings,\n  country: CountryCodes,\n  language: LanguageCodes | undefined,\n): ParsedThankYouPageConfig {\n  return {\n    optimizeId: getOptimizeConfig(settings.optimize, country),\n    voucherNetwork: getVoucherNetworkConfig(\n      settings.voucherNetwork,\n      country,\n      language,\n    ),\n    checkoutProducts: settings.checkoutProducts,\n  };\n}\n\nfunction getVoucherNetworkConfig(\n  settings: VoucherNetworkSettings,\n  country: CountryCodes | undefined,\n  language: LanguageCodes | undefined,\n): VoucherNetworkLanguage | undefined {\n  const languageSettings = getLanguageSettings(settings, country, language);\n  if (\n    !languageSettings ||\n    !languageSettings.isEnabled ||\n    !languageSettings.trafficMediumNumber ||\n    !languageSettings.trafficSourceNumber\n  ) {\n    return undefined;\n  }\n  return languageSettings;\n}\n\nfunction getLanguageSettings(\n  settings: VoucherNetworkSettings,\n  country: CountryCodes | undefined,\n  language: LanguageCodes | undefined,\n): VoucherNetworkLanguage | undefined {\n  if (!country) {\n    window.sovThankyouStatus.countryCodePassedOnByPlugin = false;\n    return undefined;\n  }\n  window.sovThankyouStatus.countryCodePassedOnByPlugin = true;\n  const countrySettings = settings.countries[country];\n  const languagesSettings = countrySettings?.languages;\n  if (!languagesSettings) {\n    return undefined;\n  }\n  const languagesSettingsList = Object.values(languagesSettings);\n  if (languagesSettingsList?.length === 1) {\n    const languageSettings = languagesSettingsList[0];\n    return languageSettings;\n  }\n  if (languagesSettingsList?.length > 1) {\n    const languageKey = language || detectLanguageCode();\n    const languageSettings = languagesSettings[languageKey];\n    if (!languageSettings) {\n      return undefined;\n    }\n    return languageSettings;\n  }\n  return undefined;\n}\n\nfunction detectLanguageCode(): LanguageCodes {\n  const htmlLang = document.documentElement.lang.split(\"-\")[0];\n  if (htmlLang) {\n    return htmlLang as LanguageCodes;\n  }\n  return navigator.language.split(\"-\")[0] as LanguageCodes;\n}\n\nvoid sovendusThankYou();\n"],"names":["getCookie","setCookie"],"mappings":"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"}